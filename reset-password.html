<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MyMood - Restablecer Contrase√±a</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex; align-items: center; justify-content: center;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 450px; width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }
    .icon { font-size: 72px; margin-bottom: 20px; }
    h1 { color: #1f2937; margin-bottom: 16px; font-size: 28px; font-weight: 700; }
    .description { color: #6b7280; margin-bottom: 32px; line-height: 1.6; font-size: 16px; }
    .form-group { margin-bottom: 20px; text-align: left; }
    label { display: block; margin-bottom: 8px; color: #374151; font-weight: 600; font-size: 14px; }
    input[type="password"] {
      width: 100%; padding: 16px;
      border: 2px solid #e5e7eb; border-radius: 12px;
      font-size: 16px; box-sizing: border-box;
    }
    .submit-btn {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white; padding: 16px 32px;
      border: none; border-radius: 12px;
      font-size: 16px; font-weight: 600;
      cursor: pointer; width: 100%;
    }
    .error, .success {
      margin-top: 12px; font-size: 14px; padding: 12px; border-radius: 8px;
      display: none; text-align: left;
    }
    .error {
      color: #ef4444; background: #fef2f2; border-left: 4px solid #ef4444;
    }
    .success {
      color: #10b981; background: #f0fdf4; border-left: 4px solid #10b981;
    }
    .loading { display: none; margin-top: 20px; }
    .spinner {
      border: 3px solid #f3f3f3; border-top: 3px solid #8b5cf6;
      border-radius: 50%; width: 24px; height: 24px;
      animation: spin 1s linear infinite; margin: 0 auto 12px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .debug-info {
      background: #f8fafc; border: 1px solid #e2e8f0;
      border-radius: 8px; padding: 16px; margin-top: 20px;
      font-family: monospace; font-size: 12px; text-align: left;
      max-height: 200px; overflow-y: auto;
    }
    .success-container { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div id="form-container">
      <div class="icon">üîë</div>
      <h1>Restablecer Contrase√±a</h1>
      <p class="description">Crea una nueva contrase√±a segura para tu cuenta</p>

      <form id="reset-form">
        <div class="form-group">
          <label for="password">Nueva Contrase√±a</label>
          <input type="password" id="password" required minlength="6" placeholder="M√≠nimo 6 caracteres" />
        </div>
        <div class="form-group">
          <label for="confirm-password">Confirmar Contrase√±a</label>
          <input type="password" id="confirm-password" required placeholder="Repite la nueva contrase√±a" />
        </div>
        <button type="submit" class="submit-btn" id="submit-btn">Actualizar Contrase√±a</button>

        <div id="loading" class="loading">
          <div class="spinner"></div>
          <p>Procesando...</p>
        </div>

        <div id="error-message" class="error"></div>
        <div id="success-message" class="success"></div>
      </form>

      <div class="debug-info" id="debug-info">
        <strong>Debug Info:</strong><br />
        <div id="debug-content"></div>
      </div>
    </div>

    <div id="success-container" class="success-container">
      <div class="icon">‚úÖ</div>
      <h1>¬°Contrase√±a Actualizada!</h1>
      <p class="description">Tu contrase√±a se ha cambiado exitosamente.</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = "https://qorwfcywheqxgzukzodp.supabase.co";
    const SUPABASE_ANON_KEY = "TU_ANON_KEY_AQUI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById("reset-form");
    const passwordInput = document.getElementById("password");
    const confirmPasswordInput = document.getElementById("confirm-password");
    const submitBtn = document.getElementById("submit-btn");
    const loading = document.getElementById("loading");
    const errorMessage = document.getElementById("error-message");
    const successMessage = document.getElementById("success-message");
    const formContainer = document.getElementById("form-container");
    const successContainer = document.getElementById("success-container");
    const debugContent = document.getElementById("debug-content");

    let currentSession = null;

    function addDebugInfo(info) {
      const timestamp = new Date().toLocaleTimeString();
      debugContent.innerHTML += `[${timestamp}] ${info}<br>`;
      console.log("üîê [RESET]", info);
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = "block";
      successMessage.style.display = "none";
      addDebugInfo("ERROR: " + message);
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.style.display = "block";
      errorMessage.style.display = "none";
    }

    function showLoading(show) {
      loading.style.display = show ? "block" : "none";
      submitBtn.disabled = show;
      submitBtn.textContent = show ? "Procesando..." : "Actualizar Contrase√±a";
    }

    // Inicializaci√≥n
    async function init() {
      addDebugInfo("Page loaded");
      addDebugInfo("Full URL: " + window.location.href);

      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get("code");

      if (code) {
        try {
          addDebugInfo("Encontrado code: " + code.substring(0, 8) + "...");
          const { data, error } = await supabase.auth.exchangeCodeForSession(code);
          if (error) throw error;
          if (data.session) {
            currentSession = data.session;
            addDebugInfo("Sesi√≥n establecida para: " + data.session.user.email);
            return;
          }
        } catch (err) {
          addDebugInfo("exchangeCodeForSession error: " + err.message);
          return showError("El enlace de restablecimiento ha expirado o es inv√°lido.");
        }
      }

      showError("Enlace de restablecimiento inv√°lido o expirado. Solicita uno nuevo.");
    }

    // Manejar reset de contrase√±a
    async function handlePasswordReset() {
      const password = passwordInput.value;
      const confirmPassword = confirmPasswordInput.value;

      if (password.length < 6) return showError("La contrase√±a debe tener al menos 6 caracteres");
      if (password !== confirmPassword) return showError("Las contrase√±as no coinciden");
      if (!currentSession) return showError("No hay sesi√≥n v√°lida. Solicita un nuevo enlace.");

      showLoading(true);
      try {
        const { error } = await supabase.auth.updateUser({ password });
        if (error) throw error;

        await supabase.auth.signOut();
        formContainer.style.display = "none";
        successContainer.style.display = "block";
        addDebugInfo("Contrase√±a actualizada y sesi√≥n cerrada.");
      } catch (err) {
        showError(err.message || "Error al actualizar la contrase√±a.");
      } finally {
        showLoading(false);
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      await handlePasswordReset();
    });

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
